from django.conf import settings
from django.db import models
from localflavor.us.models import USStateField
from localflavor.us.us_states import STATE_CHOICES
from django.db.utils import DatabaseError
from django.core.validators import MinValueValidator


TOP_100_CITY_DATA = [{u'us-populationrank': u'1', u'place-short': 'NY', u'state': u'New York', u'place': u'New York', u'state-short': 'NY', u'population-growth': u'5.9%', u'population': u'8,491,079'}, {u'us-populationrank': u'2', u'state': u'California', u'place': u'Los Angeles', u'state-short': 'CA', u'population-growth': u'6.0%', u'population': u'3,928,864'}, {u'us-populationrank': u'3', u'state': u'Illinois', u'place': u'Chicago', u'state-short': 'IL', u'population-growth': u'-5.9%', u'population': u'2,722,389'}, {u'us-populationrank': u'4', u'state': u'Texas', u'place': u'Houston', u'state-short': 'TX', u'population-growth': u'13.2%', u'population': u'2,239,558'}, {u'us-populationrank': u'5', u'state': u'Pennsylvania', u'place': u'Philadelphia', u'state-short': 'PA', u'population-growth': u'3.0%', u'population': u'1,560,297'}, {u'us-populationrank': u'6', u'state': u'Arizona', u'place': u'Phoenix', u'state-short': 'AZ', u'population-growth': u'15.8%', u'population': u'1,537,058'}, {u'us-populationrank': u'7', u'state': u'Texas', u'place': u'San Antonio', u'state-short': 'TX', u'population-growth': u'23.4%', u'population': u'1,436,697'}, {u'us-populationrank': u'8', u'state': u'California', u'place': u'San Diego', u'state-short': 'CA', u'population-growth': u'12.5%', u'population': u'1,381,069'}, {u'us-populationrank': u'9', u'state': u'Texas', u'place': u'Dallas', u'state-short': 'TX', u'population-growth': u'7.5%', u'population': u'1,281,047'}, {u'us-populationrank': u'10', u'state': u'California', u'place': u'San Jose', u'state-short': 'CA', u'population-growth': u'12.4%', u'population': u'1,015,785'}, {u'us-populationrank': u'11', u'state': u'Texas', u'place': u'Austin', u'state-short': 'TX', u'population-growth': u'35.7%', u'population': u'912,791'}, {u'us-populationrank': u'12', u'state': u'Florida', u'place': u'Jacksonville', u'state-short': 'FL', u'population-growth': u'15.8%', u'population': u'853,382'}, {u'us-populationrank': u'13', u'state': u'California', u'place': u'San Francisco', u'state-short': 'CA', u'population-growth': u'9.6%', u'population': u'852,469'}, {u'us-populationrank': u'14', u'state': u'Indiana', u'place': u'Indianapolis', u'state-short': 'IN', u'population-growth': u'8.5%', u'population': u'848,788'}, {u'us-populationrank': u'15', u'state': u'Ohio', u'place': u'Columbus', u'state-short': 'OH', u'population-growth': u'16.7%', u'population': u'835,957'}, {u'us-populationrank': u'16', u'state': u'Texas', u'place': u'Fort Worth', u'state-short': 'TX', u'population-growth': u'48.7%', u'population': u'812,238'}, {u'us-populationrank': u'17', u'state': u'North Carolina', u'place': u'Charlotte', u'state-short': 'NC', u'population-growth': u'42.1%', u'population': u'809,958'}, {u'us-populationrank': u'18', u'state': u'Michigan', u'place': u'Detroit', u'state-short': 'MI', u'population-growth': u'-28.0%', u'population': u'680,250'}, {u'us-populationrank': u'19', u'state': u'Texas', u'place': u'El Paso', u'state-short': 'TX', u'population-growth': u'20.2%', u'population': u'679,036'}, {u'us-populationrank': u'20', u'state': u'Washington', u'place': u'Seattle', u'state-short': 'WA', u'population-growth': u'18.4%', u'population': u'668,342'}, {u'us-populationrank': u'21', u'state': u'Colorado', u'place': u'Denver', u'state-short': 'CO', u'population-growth': u'19.3%', u'population': u'663,862'}, {u'us-populationrank': u'22', u'place-short': 'WA', u'state': u'District of Columbia', u'place': u'Washington', u'state-short': 'DC', u'population-growth': u'15.2%', u'population': u'658,893'}, {u'us-populationrank': u'23', u'state': u'Tennessee', u'place': u'Memphis', u'state-short': 'TN', u'population-growth': u'-4.8%', u'population': u'656,861'}, {u'us-populationrank': u'24', u'state': u'Massachusetts', u'place': u'Boston', u'state-short': 'MA', u'population-growth': u'11.0%', u'population': u'655,884'}, {u'us-populationrank': u'25', u'state': u'Tennessee', u'place': u'Nashville-Davidson', u'state-short': 'TN', u'population-growth': u'17.9%', u'population': u'644,014'}, {u'us-populationrank': u'26', u'state': u'Maryland', u'place': u'Baltimore', u'state-short': 'MD', u'population-growth': u'-3.9%', u'population': u'622,793'}, {u'us-populationrank': u'27', u'state': u'Oklahoma', u'place': u'Oklahoma City', u'state-short': 'OK', u'population-growth': u'22.2%', u'population': u'620,602'}, {u'us-populationrank': u'28', u'state': u'Oregon', u'place': u'Portland', u'state-short': 'OR', u'population-growth': u'16.8%', u'population': u'619,360'}, {u'us-populationrank': u'29', u'state': u'Nevada', u'place': u'Las Vegas', u'state-short': 'NV', u'population-growth': u'26.6%', u'population': u'613,599'}, {u'us-populationrank': u'30', u'state': u'Kentucky', u'place': u'Louisville/Jefferson County', u'state-short': 'KY', u'population-growth': u'10.6%', u'population': u'612,780'}, {u'us-populationrank': u'31', u'state': u'Wisconsin', u'place': u'Milwaukee', u'state-short': 'WI', u'population-growth': u'0.4%', u'population': u'599,642'}, {u'us-populationrank': u'32', u'state': u'New Mexico', u'place': u'Albuquerque', u'state-short': 'NM', u'population-growth': u'23.6%', u'population': u'557,169'}, {u'us-populationrank': u'33', u'state': u'Arizona', u'place': u'Tucson', u'state-short': 'AZ', u'population-growth': u'7.8%', u'population': u'527,972'}, {u'us-populationrank': u'34', u'state': u'California', u'place': u'Fresno', u'state-short': 'CA', u'population-growth': u'19.7%', u'population': u'515,986'}, {u'us-populationrank': u'35', u'state': u'California', u'place': u'Sacramento', u'state-short': 'CA', u'population-growth': u'18.5%', u'population': u'485,199'}, {u'us-populationrank': u'36', u'state': u'California', u'place': u'Long Beach', u'state-short': 'CA', u'population-growth': u'2.4%', u'population': u'473,577'}, {u'us-populationrank': u'37', u'state': u'Missouri', u'place': u'Kansas City', u'state-short': 'MO', u'population-growth': u'6.4%', u'population': u'470,800'}, {u'us-populationrank': u'38', u'state': u'Arizona', u'place': u'Mesa', u'state-short': 'AZ', u'population-growth': u'15.3%', u'population': u'464,704'}, {u'us-populationrank': u'39', u'state': u'Georgia', u'place': u'Atlanta', u'state-short': 'GA', u'population-growth': u'8.2%', u'population': u'456,002'}, {u'us-populationrank': u'40', u'state': u'Virginia', u'place': u'Virginia Beach', u'state-short': 'VA', u'population-growth': u'5.7%', u'population': u'450,980'}, {u'us-populationrank': u'41', u'state': u'Nebraska', u'place': u'Omaha', u'state-short': 'NE', u'population-growth': u'8.9%', u'population': u'446,599'}, {u'us-populationrank': u'42', u'state': u'Colorado', u'place': u'Colorado Springs', u'state-short': 'CO', u'population-growth': u'23.0%', u'population': u'445,830'}, {u'us-populationrank': u'43', u'state': u'North Carolina', u'place': u'Raleigh', u'state-short': 'NC', u'population-growth': u'51.5%', u'population': u'439,896'}, {u'us-populationrank': u'44', u'state': u'Florida', u'place': u'Miami', u'state-short': 'FL', u'population-growth': u'18.4%', u'population': u'430,332'}, {u'us-populationrank': u'45', u'state': u'California', u'place': u'Oakland', u'state-short': 'CA', u'population-growth': u'3.2%', u'population': u'413,775'}, {u'us-populationrank': u'46', u'state': u'Minnesota', u'place': u'Minneapolis', u'state-short': 'MN', u'population-growth': u'6.4%', u'population': u'407,207'}, {u'us-populationrank': u'47', u'state': u'Oklahoma', u'place': u'Tulsa', u'state-short': 'OK', u'population-growth': u'1.7%', u'population': u'399,682'}, {u'us-populationrank': u'48', u'state': u'Ohio', u'place': u'Cleveland', u'state-short': 'OH', u'population-growth': u'-18.2%', u'population': u'389,521'}, {u'us-populationrank': u'49', u'state': u'Kansas', u'place': u'Wichita', u'state-short': 'KS', u'population-growth': u'10.2%', u'population': u'388,413'}, {u'us-populationrank': u'50', u'state': u'Louisiana', u'place': u'New Orleans', u'state-short': 'LA', u'population-growth': u'-20.5%', u'population': u'384,320'}, {u'us-populationrank': u'51', u'state': u'Texas', u'place': u'Arlington', u'state-short': 'TX', u'population-growth': u'14.4%', u'population': u'383,204'}, {u'us-populationrank': u'52', u'state': u'California', u'place': u'Bakersfield', u'state-short': 'CA', u'population-growth': u'50.5%', u'population': u'368,759'}, {u'us-populationrank': u'53', u'state': u'Florida', u'place': u'Tampa', u'state-short': 'FL', u'population-growth': u'17.9%', u'population': u'358,699'}, {u'us-populationrank': u'54', u'state': u'Colorado', u'place': u'Aurora', u'state-short': 'CO', u'population-growth': u'27.0%', u'population': u'353,108'}, {u'us-populationrank': u'55', u'state': u'Hawaii', u'place': u'Honolulu', u'state-short': 'HI', u'population-growth': u'-5.5%', u'population': u'350,399'}, {u'us-populationrank': u'56', u'state': u'California', u'place': u'Anaheim', u'state-short': 'CA', u'population-growth': u'5.3%', u'population': u'346,997'}, {u'us-populationrank': u'57', u'state': u'California', u'place': u'Santa Ana', u'state-short': 'CA', u'population-growth': u'-1.0%', u'population': u'334,909'}, {u'us-populationrank': u'58', u'state': u'Texas', u'place': u'Corpus Christi', u'state-short': 'TX', u'population-growth': u'15.5%', u'population': u'320,434'}, {u'us-populationrank': u'59', u'state': u'California', u'place': u'Riverside', u'state-short': 'CA', u'population-growth': u'23.6%', u'population': u'319,504'}, {u'us-populationrank': u'60', u'state': u'Missouri', u'place': u'St. Louis', u'state-short': 'MO', u'population-growth': u'-8.4%', u'population': u'317,419'}, {u'us-populationrank': u'61', u'state': u'Kentucky', u'place': u'Lexington-Fayette', u'state-short': 'KY', u'population-growth': u'18.9%', u'population': u'310,797'}, {u'us-populationrank': u'62', u'state': u'Pennsylvania', u'place': u'Pittsburgh', u'state-short': 'PA', u'population-growth': u'-8.4%', u'population': u'305,412'}, {u'us-populationrank': u'63', u'state': u'California', u'place': u'Stockton', u'state-short': 'CA', u'population-growth': u'23.6%', u'population': u'302,389'}, {u'us-populationrank': u'64', u'state': u'Alaska', u'place': u'Anchorage', u'state-short': 'AK', u'population-growth': u'15.5%', u'population': u'301,010'}, {u'us-populationrank': u'65', u'state': u'Ohio', u'place': u'Cincinnati', u'state-short': 'OH', u'population-growth': u'-9.9%', u'population': u'298,165'}, {u'us-populationrank': u'66', u'state': u'Minnesota', u'place': u'St. Paul', u'state-short': 'MN', u'population-growth': u'3.7%', u'population': u'297,640'}, {u'us-populationrank': u'67', u'state': u'North Carolina', u'place': u'Greensboro', u'state-short': 'NC', u'population-growth': u'23.6%', u'population': u'282,586'}, {u'us-populationrank': u'68', u'state': u'Ohio', u'place': u'Toledo', u'state-short': 'OH', u'population-growth': u'-10.4%', u'population': u'281,031'}, {u'us-populationrank': u'69', u'state': u'New Jersey', u'place': u'Newark', u'state-short': 'NJ', u'population-growth': u'2.9%', u'population': u'280,579'}, {u'us-populationrank': u'70', u'state': u'Texas', u'place': u'Plano', u'state-short': 'TX', u'population-growth': u'24.2%', u'population': u'278,480'}, {u'us-populationrank': u'71', u'state': u'Nevada', u'place': u'Henderson', u'state-short': 'NV', u'population-growth': u'54.7%', u'population': u'277,440'}, {u'us-populationrank': u'72', u'state': u'Nebraska', u'place': u'Lincoln', u'state-short': 'NE', u'population-growth': u'19.8%', u'population': u'272,996'}, {u'us-populationrank': u'73', u'state': u'Florida', u'place': u'Orlando', u'state-short': 'FL', u'population-growth': u'34.7%', u'population': u'262,372'}, {u'us-populationrank': u'74', u'state': u'New Jersey', u'place': u'Jersey City', u'state-short': 'NJ', u'population-growth': u'9.2%', u'population': u'262,146'}, {u'us-populationrank': u'75', u'state': u'California', u'place': u'Chula Vista', u'state-short': 'CA', u'population-growth': u'48.6%', u'population': u'260,988'}, {u'us-populationrank': u'76', u'state': u'New York', u'place': u'Buffalo', u'state-short': 'NY', u'population-growth': u'-11.4%', u'population': u'258,703'}, {u'us-populationrank': u'77', u'state': u'Indiana', u'place': u'Fort Wayne', u'state-short': 'IN', u'population-growth': u'1.8%', u'population': u'258,522'}, {u'us-populationrank': u'78', u'state': u'Arizona', u'place': u'Chandler', u'state-short': 'AZ', u'population-growth': u'41.5%', u'population': u'254,276'}, {u'us-populationrank': u'79', u'state': u'Florida', u'place': u'St. Petersburg', u'state-short': 'FL', u'population-growth': u'1.9%', u'population': u'253,693'}, {u'us-populationrank': u'80', u'state': u'Texas', u'place': u'Laredo', u'state-short': 'TX', u'population-growth': u'40.5%', u'population': u'252,309'}, {u'us-populationrank': u'81', u'state': u'North Carolina', u'place': u'Durham', u'state-short': 'NC', u'population-growth': u'33.3%', u'population': u'251,893'}, {u'us-populationrank': u'82', u'state': u'California', u'place': u'Irvine', u'state-short': 'CA', u'population-growth': u'69.4%', u'population': u'248,531'}, {u'us-populationrank': u'83', u'state': u'Wisconsin', u'place': u'Madison', u'state-short': 'WI', u'population-growth': u'16.9%', u'population': u'245,691'}, {u'us-populationrank': u'84', u'state': u'Virginia', u'place': u'Norfolk', u'state-short': 'VA', u'population-growth': u'4.7%', u'population': u'245,428'}, {u'us-populationrank': u'85', u'state': u'Texas', u'place': u'Lubbock', u'state-short': 'TX', u'population-growth': u'21.7%', u'population': u'243,839'}, {u'us-populationrank': u'86', u'state': u'Arizona', u'place': u'Gilbert', u'state-short': 'AZ', u'population-growth': u'103.9%', u'population': u'239,277'}, {u'us-populationrank': u'87', u'state': u'North Carolina', u'place': u'Winston-Salem', u'state-short': 'NC', u'population-growth': u'18.3%', u'population': u'239,269'}, {u'us-populationrank': u'88', u'state': u'Arizona', u'place': u'Glendale', u'state-short': 'AZ', u'population-growth': u'7.0%', u'population': u'237,517'}, {u'us-populationrank': u'89', u'state': u'Nevada', u'place': u'Reno', u'state-short': 'NV', u'population-growth': u'28.8%', u'population': u'236,995'}, {u'us-populationrank': u'90', u'state': u'Florida', u'place': u'Hialeah', u'state-short': 'FL', u'population-growth': u'4.1%', u'population': u'235,563'}, {u'us-populationrank': u'91', u'state': u'Texas', u'place': u'Garland', u'state-short': 'TX', u'population-growth': u'9.0%', u'population': u'235,501'}, {u'us-populationrank': u'92', u'state': u'Virginia', u'place': u'Chesapeake', u'state-short': 'VA', u'population-growth': u'16.5%', u'population': u'233,371'}, {u'us-populationrank': u'93', u'state': u'Texas', u'place': u'Irving', u'state-short': 'TX', u'population-growth': u'21.0%', u'population': u'232,406'}, {u'us-populationrank': u'94', u'state': u'Nevada', u'place': u'North Las Vegas', u'state-short': 'NV', u'population-growth': u'95.6%', u'population': u'230,788'}, {u'us-populationrank': u'95', u'state': u'Arizona', u'place': u'Scottsdale', u'state-short': 'AZ', u'population-growth': u'12.8%', u'population': u'230,512'}, {u'us-populationrank': u'96', u'state': u'Louisiana', u'place': u'Baton Rouge', u'state-short': 'LA', u'population-growth': u'0.2%', u'population': u'228,895'}, {u'us-populationrank': u'97', u'state': u'California', u'place': u'Fremont', u'state-short': 'CA', u'population-growth': u'11.9%', u'population': u'228,758'}, {u'us-populationrank': u'98', u'state': u'Virginia', u'place': u'Richmond', u'state-short': 'VA', u'population-growth': u'10.1%', u'population': u'217,853'}, {u'us-populationrank': u'99', u'state': u'Idaho', u'place': u'Boise City', u'state-short': 'ID', u'population-growth': u'10.5%', u'population': u'216,282'}, {u'us-populationrank': u'100', u'state': u'California', u'place': u'San Bernardino', u'state-short': 'CA', u'population-growth': u'13.8%', u'population': u'215,213'}]

SLUG_CHOICES = ((i, x['place'] + ', ' + x['state-short']) for i,x in enumerate(TOP_100_CITY_DATA))
REVERSE_STATE_CHOICES = {y:x for x,y in STATE_CHOICES}

class WeatherSubscriber(models.Model):
	city = models.CharField(max_length=255)
	#two letter state abbrevation
	state = USStateField(choices=STATE_CHOICES)
	email = models.EmailField(null=True, blank=True, db_index=True)
	# for finger printing to combat spam
	#https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Basic_usage
	#http://stackoverflow.com/questions/15685698/getting-binary-base64-data-from-html5-canvas-readasbinarystring
	canvas_tagging = models.TextField(null=True,blank=True)
	ip_address = models.TextField(null=True,blank=True)
	user_agent = models.TextField(null=True,blank=True)
	latitude = models.FloatField(default=0.0)
	longitude = models.FloatField(default=0.0)

	created_at = models.DateTimeField(auto_now_add=True)
	modified_at = models.DateTimeField(auto_now=True)

	def generate_city_state_slug(self):
		return self.city + ', ' + REVERSE_STATE_CHOICES[self.state]